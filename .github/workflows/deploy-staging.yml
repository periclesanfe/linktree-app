name: Deploy to Staging

on:
  push:
    branches:
      - develop
  workflow_dispatch:

env:
  PROJECT_NAME: linktree

jobs:
  deploy-staging:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.STAGING_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.STAGING_VM_IP }} >> ~/.ssh/known_hosts

      - name: Deploy to Staging VM
        env:
          VM_IP: ${{ secrets.STAGING_VM_IP }}
          VM_USER: ${{ secrets.STAGING_VM_USER }}
          PROJECT_DIR: ${{ secrets.STAGING_PROJECT_DIR }}
        run: |
          ssh -o StrictHostKeyChecking=no $VM_USER@$VM_IP << 'EOF'
            set -e

            echo "ðŸš€ Iniciando deploy para STAGING..."

            cd ${{ secrets.STAGING_PROJECT_DIR }}

            # Pull das Ãºltimas mudanÃ§as da branch develop
            echo "ðŸ“¥ Baixando Ãºltimas mudanÃ§as do GitHub (develop)..."
            git fetch origin
            git checkout develop
            git pull origin develop

            # Parar containers
            echo "â¸ï¸  Parando containers..."
            docker compose -f docker-compose.yml down

            # Rebuild e restart dos containers (usando docker-compose.yml para staging)
            echo "ðŸ”¨ Reconstruindo e iniciando containers..."
            docker compose -f docker-compose.yml up -d --build

            # Aguardar containers iniciarem
            echo "â³ Aguardando containers iniciarem..."
            sleep 10

            # Limpar imagens antigas
            echo "ðŸ§¹ Limpando imagens antigas..."
            docker image prune -af

            # Verificar status
            echo "âœ… Verificando status dos containers..."
            docker compose -f docker-compose.yml ps

            echo "ðŸŽ‰ Deploy STAGING concluÃ­do com sucesso!"
          EOF

      - name: Health Check
        run: |
          echo "ðŸ¥ Verificando saÃºde da aplicaÃ§Ã£o STAGING..."
          sleep 5
          response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.STAGING_VM_IP }}:3000/api/health || echo "000")

          if [ "$response" = "200" ]; then
            echo "âœ… AplicaÃ§Ã£o STAGING estÃ¡ saudÃ¡vel!"
          else
            echo "âš ï¸  AplicaÃ§Ã£o STAGING retornou cÃ³digo $response (pode ser normal se usar porta diferente)"
          fi

      - name: Cleanup SSH
        if: always()
        run: rm -f ~/.ssh/id_rsa
