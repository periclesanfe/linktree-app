# Este arquivo é um exemplo de como criar um cluster PostgreSQL usando CloudNativePG
# Este arquivo deve ser colocado no repositório GitOps (argocd-gitops)

---
# Cluster PostgreSQL para desenvolvimento
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: linktree-dev-postgresql
  namespace: dev
spec:
  # Número de instâncias (1 primária + replicas)
  instances: 2
  
  # Versão do PostgreSQL
  imageName: ghcr.io/cloudnative-pg/postgresql:16
  
  # Credenciais iniciais do superusuário
  bootstrap:
    initdb:
      database: linktree_dev
      owner: linktree_dev_user
      # Secret com a senha do owner
      secret:
        name: linktree-dev-db-credentials
  
  # Armazenamento
  storage:
    size: 5Gi
    storageClass: standard
  
  # Recursos
  resources:
    requests:
      memory: "256Mi"
      cpu: "250m"
    limits:
      memory: "512Mi"
      cpu: "500m"
  
  # Configurações do PostgreSQL
  postgresql:
    parameters:
      max_connections: "100"
      shared_buffers: "128MB"
      effective_cache_size: "512MB"
      work_mem: "4MB"
  
  # Monitoramento
  monitoring:
    enablePodMonitor: true
  
  # Backup (opcional)
  # backup:
  #   barmanObjectStore:
  #     destinationPath: s3://bucket/path
  #     s3Credentials:
  #       accessKeyId:
  #         name: backup-credentials
  #         key: ACCESS_KEY_ID
  #       secretAccessKey:
  #         name: backup-credentials
  #         key: SECRET_ACCESS_KEY

---
# Secret com credenciais do banco (dev)
apiVersion: v1
kind: Secret
metadata:
  name: linktree-dev-db-credentials
  namespace: dev
type: kubernetes.io/basic-auth
stringData:
  username: linktree_dev_user
  password: dev_password_123

---
# Cluster PostgreSQL para produção
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: linktree-prod-postgresql
  namespace: prod
spec:
  instances: 3  # Alta disponibilidade
  
  imageName: ghcr.io/cloudnative-pg/postgresql:16
  
  bootstrap:
    initdb:
      database: linktree_prod
      owner: linktree_prod_user
      secret:
        name: linktree-prod-db-credentials
  
  storage:
    size: 20Gi
    storageClass: fast-ssd  # Use uma storage class rápida em produção
  
  resources:
    requests:
      memory: "1Gi"
      cpu: "500m"
    limits:
      memory: "2Gi"
      cpu: "1000m"
  
  postgresql:
    parameters:
      max_connections: "200"
      shared_buffers: "512MB"
      effective_cache_size: "1536MB"
      work_mem: "8MB"
      maintenance_work_mem: "128MB"
      random_page_cost: "1.1"
      effective_io_concurrency: "200"
  
  # Alta disponibilidade
  primaryUpdateStrategy: unsupervised
  
  # Monitoramento
  monitoring:
    enablePodMonitor: true
  
  # Backup automático
  backup:
    retentionPolicy: "30d"
    barmanObjectStore:
      destinationPath: s3://linktree-backups/postgres
      s3Credentials:
        accessKeyId:
          name: backup-credentials
          key: ACCESS_KEY_ID
        secretAccessKey:
          name: backup-credentials
          key: SECRET_ACCESS_KEY
      wal:
        compression: gzip
  
  # Agendamento de backup
  # scheduledBackup:
  #   - name: daily-backup
  #     schedule: "0 0 2 * * *"  # 2 AM todos os dias
  #     backupOwnerReference: self

---
# Secret com credenciais do banco (prod)
# ⚠️ IMPORTANTE: Em produção, use Sealed Secrets ou External Secrets Operator
apiVersion: v1
kind: Secret
metadata:
  name: linktree-prod-db-credentials
  namespace: prod
type: kubernetes.io/basic-auth
stringData:
  username: linktree_prod_user
  password: REPLACE_WITH_SECURE_PASSWORD

---
# Scheduled Backup para produção
apiVersion: postgresql.cnpg.io/v1
kind: ScheduledBackup
metadata:
  name: linktree-prod-daily-backup
  namespace: prod
spec:
  schedule: "0 0 2 * * *"  # 2 AM todos os dias
  backupOwnerReference: self
  cluster:
    name: linktree-prod-postgresql
