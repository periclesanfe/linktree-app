{{- if .Values.migration.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "linktree-database.fullname" . }}-migration
  labels:
    {{- include "linktree-database.labels" . | nindent 4 }}
    app.kubernetes.io/component: db-migration
  annotations:
    # ArgoCD Sync Wave: Este Job será executado ANTES dos Deployments (wave 0)
    argocd.argoproj.io/sync-wave: "-1"
    # Hook para executar antes do sync
    argocd.argoproj.io/hook: PreSync
    # Deletar o Job após sucesso para evitar conflitos em próximos syncs
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  ttlSecondsAfterFinished: {{ .Values.migration.ttlSecondsAfterFinished }}
  backoffLimit: {{ .Values.migration.backoffLimit }}
  template:
    metadata:
      name: {{ include "linktree-database.fullname" . }}-migration
      labels:
        {{- include "linktree-database.labels" . | nindent 8 }}
        app.kubernetes.io/component: db-migration
    spec:
      restartPolicy: OnFailure
      containers:
      - name: db-migration
        image: "{{ .Values.migration.image.repository }}:{{ .Values.migration.image.tag }}"
        imagePullPolicy: {{ .Values.migration.image.pullPolicy }}
        env:
        - name: PGHOST
          value: "{{ include "linktree-database.fullname" . }}-postgresql-rw"
        - name: PGPORT
          value: "5432"
        - name: PGDATABASE
          value: {{ .Values.postgresql.database | quote }}
        - name: PGUSER
          valueFrom:
            secretKeyRef:
              name: {{ .Values.postgresql.credentialsSecret }}
              key: username
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Values.postgresql.credentialsSecret }}
              key: password
        command:
        - /bin/sh
        - -c
        - |
          echo "Aguardando PostgreSQL estar disponível..."
          until pg_isready -h $PGHOST -p $PGPORT -U $PGUSER; do
            echo "PostgreSQL não está pronto - aguardando..."
            sleep 2
          done
          echo "PostgreSQL está pronto! Executando migrações..."
          psql -v ON_ERROR_STOP=1 << 'EOF'
          -- Habilita a extensão para gerar UUIDs, caso ainda não esteja habilitada.
          CREATE EXTENSION IF NOT EXISTS "pgcrypto";

          -- Cria uma função que será usada por gatilhos (triggers) para atualizar o campo updated_at.
          CREATE OR REPLACE FUNCTION trigger_set_timestamp()
          RETURNS TRIGGER AS $BODY$
          BEGIN
            NEW.updated_at = NOW();
            RETURN NEW;
          END;
          $BODY$ LANGUAGE plpgsql;

          -- Tabela para guardar os usuários
          CREATE TABLE IF NOT EXISTS users (
              id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
              username VARCHAR(50) UNIQUE NOT NULL,
              email VARCHAR(255) UNIQUE NOT NULL,
              password_hash VARCHAR(255) NOT NULL,
              display_name VARCHAR(100),
              bio TEXT,
              profile_image_url TEXT,
              background_image_url TEXT,
              created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
              updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
          );

          DROP TRIGGER IF EXISTS set_timestamp ON users;
          CREATE TRIGGER set_timestamp
          BEFORE UPDATE ON users
          FOR EACH ROW
          EXECUTE PROCEDURE trigger_set_timestamp();

          -- Tabela para guardar os links de cada usuário
          CREATE TABLE IF NOT EXISTS links (
              id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
              user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
              title VARCHAR(100) NOT NULL,
              url VARCHAR(2048) NOT NULL,
              display_order INTEGER NOT NULL DEFAULT 0,
              cover_image_url TEXT,
              color_hash VARCHAR(7),
              created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
              updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
          );

          DROP TRIGGER IF EXISTS set_timestamp ON links;
          CREATE TRIGGER set_timestamp
          BEFORE UPDATE ON links
          FOR EACH ROW
          EXECUTE PROCEDURE trigger_set_timestamp();

          -- Tabela para guardar os ícones de redes sociais
          CREATE TABLE IF NOT EXISTS social_icons (
              id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
              user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
              platform VARCHAR(50) NOT NULL CHECK (platform IN ('instagram', 'twitter', 'facebook', 'tiktok', 'youtube', 'linkedin', 'github', 'whatsapp')),
              url VARCHAR(2048) NOT NULL,
              created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
              updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
          );

          DROP TRIGGER IF EXISTS set_timestamp ON social_icons;
          CREATE TRIGGER set_timestamp
          BEFORE UPDATE ON social_icons
          FOR EACH ROW
          EXECUTE PROCEDURE trigger_set_timestamp();

          -- Tabela para análise de cliques
          CREATE TABLE IF NOT EXISTS analytics_clicks (
              id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
              link_id UUID NOT NULL REFERENCES links(id) ON DELETE CASCADE,
              clicked_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
              ip_hash VARCHAR(64),
              country_code VARCHAR(2),
              city VARCHAR(100)
          );

          CREATE INDEX IF NOT EXISTS idx_analytics_clicks_link_id ON analytics_clicks(link_id);

          -- Inserir usuário de teste (senha: 123)
          INSERT INTO users (username, email, password_hash, display_name, bio)
          VALUES (
            'teste',
            'teste@t.com',
            '$2b$10$5YNi5qy47pH3SXH3VUzBbuKq1GsRX0BJmUK1raHXGil6FMUBAS4jK',
            'Usuário de Teste',
            'Conta de teste para demonstração'
          )
          ON CONFLICT (username) DO UPDATE SET
            email = EXCLUDED.email,
            password_hash = EXCLUDED.password_hash,
            display_name = EXCLUDED.display_name,
            bio = EXCLUDED.bio;

          -- Adicionar links de exemplo para o usuário de teste (apenas se não existirem)
          INSERT INTO links (user_id, title, url, display_order)
          SELECT u.id, 'GitHub', 'https://github.com', 1
          FROM users u
          WHERE u.username = 'teste'
          AND NOT EXISTS (
            SELECT 1 FROM links WHERE user_id = u.id AND title = 'GitHub'
          );

          INSERT INTO links (user_id, title, url, display_order)
          SELECT u.id, 'LinkedIn', 'https://linkedin.com', 2
          FROM users u
          WHERE u.username = 'teste'
          AND NOT EXISTS (
            SELECT 1 FROM links WHERE user_id = u.id AND title = 'LinkedIn'
          );

          INSERT INTO links (user_id, title, url, display_order)
          SELECT u.id, 'Portfolio', 'https://example.com', 3
          FROM users u
          WHERE u.username = 'teste'
          AND NOT EXISTS (
            SELECT 1 FROM links WHERE user_id = u.id AND title = 'Portfolio'
          );

          -- Adicionar ícones sociais de exemplo (apenas se não existirem)
          INSERT INTO social_icons (user_id, platform, url)
          SELECT u.id, 'instagram', 'https://instagram.com/teste'
          FROM users u
          WHERE u.username = 'teste'
          AND NOT EXISTS (
            SELECT 1 FROM social_icons WHERE user_id = u.id AND platform = 'instagram'
          );

          INSERT INTO social_icons (user_id, platform, url)
          SELECT u.id, 'github', 'https://github.com/teste'
          FROM users u
          WHERE u.username = 'teste'
          AND NOT EXISTS (
            SELECT 1 FROM social_icons WHERE user_id = u.id AND platform = 'github'
          );
          EOF
          echo "Migrações concluídas com sucesso!"
        resources:
          {{- toYaml .Values.migration.resources | nindent 10 }}
{{- end }}
