# ============================================================================
# BACKEND ROLLOUT - DEPLOYMENT AVANÇADO COM BLUEGREEN/CANARY
# ============================================================================
# Responsabilidade:
#   - Substitui o Deployment tradicional quando rollout está habilitado
#   - Implementa estratégias avançadas de deployment (BlueGreen ou Canary)
#   - Gerencia múltiplas versões simultâneas da aplicação (stable + preview/canary)
#   - Controla promoção manual ou automática entre versões
#
# Comunicação:
#   - Argo Rollouts controller monitora este recurso e gerencia ReplicaSets
#   - BlueGreen: atualiza Services (active e preview) conforme promoções
#   - Canary: integra com NGINX Ingress para controle fino de tráfego
#   - HPA pode referenciar este Rollout para autoscaling
#
# Estratégias por ambiente:
#   - DEV: BlueGreen com autoPromotionEnabled: false (promoção manual)
#   - PROD: Canary com steps progressivos (10% → 25% → 50% → 75% → 100%)
#
# Serviços relacionados:
#   - BlueGreen: backend-service.yaml (active), backend-service-preview.yaml
#   - Canary: backend-service.yaml (stable), backend-service-canary.yaml
# ============================================================================

{{- if .Values.backend.enabled }}
{{- if .Values.backend.rollout.enabled }}
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: {{ include "linktree.backend.fullname" . }}
  labels:
    {{- include "linktree.backend.labels" . | nindent 4 }}
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  {{- if not .Values.backend.autoscaling.enabled }}
  replicas: {{ .Values.backend.replicaCount }}
  {{- end }}

  # Rollout gerencia ReplicaSets com estas labels
  selector:
    matchLabels:
      {{- include "linktree.backend.selectorLabels" . | nindent 6 }}

  # Template do Pod - idêntico ao Deployment original
  template:
    metadata:
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/backend-configmap.yaml") . | sha256sum }}
      labels:
        {{- include "linktree.backend.selectorLabels" . | nindent 8 }}
    spec:
      {{- if .Values.backend.image.pullSecrets }}
      imagePullSecrets:
        {{- toYaml .Values.backend.image.pullSecrets | nindent 8 }}
      {{- end }}
      containers:
      - name: backend
        image: "{{ .Values.backend.image.repository }}:{{ .Values.backend.image.tag | default .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.backend.image.pullPolicy }}
        ports:
        - name: http
          containerPort: {{ .Values.backend.service.targetPort }}
          protocol: TCP
        # Injetar secrets e configmaps usando envFrom (best practice)
        envFrom:
        - configMapRef:
            name: {{ include "linktree.backend.fullname" . }}-config
        - secretRef:
            name: {{ .Values.backend.secretName }}
        # Variável computada DATABASE_URL
        env:
        - name: DATABASE_URL
          value: "postgresql://$(DB_USER):$(DB_PASSWORD)@$(DB_HOST):$(DB_PORT)/$(DB_NAME)"
        livenessProbe:
          {{- toYaml .Values.backend.livenessProbe | nindent 10 }}
        readinessProbe:
          {{- toYaml .Values.backend.readinessProbe | nindent 10 }}
        resources:
          {{- toYaml .Values.backend.resources | nindent 10 }}
      {{- with .Values.backend.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.backend.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.backend.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}

  # ============================================================================
  # ESTRATÉGIA: BLUEGREEN (usado em DEV)
  # ============================================================================
  {{- if eq .Values.backend.rollout.strategy "blueGreen" }}
  strategy:
    blueGreen:
      # Service que recebe tráfego de usuários (blue ou green após promoção)
      activeService: {{ include "linktree.backend.fullname" . }}

      # Service para testar nova versão antes de promover (green/preview)
      previewService: {{ include "linktree.backend.fullname" . }}-preview

      # CRÍTICO: Promoção manual obrigatória (requisito do projeto)
      autoPromotionEnabled: false

      # Tempo de espera antes de escalar down a versão antiga após promoção
      scaleDownDelaySeconds: {{ .Values.backend.rollout.blueGreen.scaleDownDelaySeconds }}

      # Anti-affinity para separar blue e green em nodes diferentes (opcional)
      {{- if .Values.backend.rollout.blueGreen.antiAffinity }}
        preferredDuringSchedulingIgnoredDuringExecution:
          blue:
            weight: 1
          green:
            weight: 1
      {{- end }}

  {{- end }}

  # ============================================================================
  # ESTRATÉGIA: CANARY (usado em PROD)
  # ============================================================================
  {{- if eq .Values.backend.rollout.strategy "canary" }}
  strategy:
    canary:
      # Service que recebe tráfego canary durante rollout
      canaryService: {{ include "linktree.backend.fullname" . }}-canary

      # Service que recebe tráfego stable
      stableService: {{ include "linktree.backend.fullname" . }}

      # Roteamento de tráfego via NGINX Ingress Controller
      trafficRouting:
        nginx:
          # Ingress principal que será manipulado pelo Argo Rollouts
          stableIngress: {{ include "linktree.backend.fullname" . }}-ingress

      # STEPS: Progressão gradual de tráfego
      # IMPORTANTE: Cada step deve ter APENAS uma ação (setWeight OU pause)
      # Separamos em steps alternados: setWeight → pause → setWeight → pause
      steps:
      # Step 1: Definir peso para 10%
      - setWeight: 10
      # Step 2: Pausar para validação
      - pause: { }

      # Step 3: Aumentar para 25%
      - setWeight: 25
      # Step 4: Pausar para validação
      - pause:
          duration: {{ .Values.backend.rollout.canary.steps.step2.pauseDuration }}

      # Step 5: Aumentar para 50%
      - setWeight: 50
      # Step 6: Pausar para validação
      - pause:
          duration: {{ .Values.backend.rollout.canary.steps.step3.pauseDuration }}

      # Step 7: Aumentar para 75%
      - setWeight: 75
      # Step 8: Pausar para validação
      - pause:
          duration: {{ .Values.backend.rollout.canary.steps.step4.pauseDuration }}

      # Step 9: Finalizar com 100%
      - setWeight: 100

      # OPCIONAL: Análise automatizada com métricas (Prometheus, etc)
      {{- if .Values.backend.rollout.canary.analysis.enabled }}
      analysis:
        templates:
        - templateName: {{ include "linktree.backend.fullname" . }}-success-rate
        startingStep: 2  # Inicia análise após 25% de tráfego
        args:
        - name: service-name
          value: {{ include "linktree.backend.fullname" . }}-canary
      {{- end }}

      # Máximo de pods extras durante rollout (além do desejado)
      maxSurge: {{ .Values.backend.rollout.canary.maxSurge }}

      # Máximo de pods indisponíveis durante rollout
      maxUnavailable: {{ .Values.backend.rollout.canary.maxUnavailable }}

  {{- end }}

  # Número de revisões antigas mantidas no histórico
  revisionHistoryLimit: 5

  # Timeout para considerar rollout como falho
  progressDeadlineSeconds: 600

{{- end }}
{{- end }}
