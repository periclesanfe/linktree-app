# ============================================================================
# FRONTEND SERVICE PREVIEW - SERVIÇO PARA TESTES PRÉ-PRODUÇÃO (BLUEGREEN)
# ============================================================================
# Responsabilidade:
#   - Expõe a nova versão (Green) da aplicação antes da promoção
#   - Permite testes e validação da nova versão sem afetar usuários
#   - Usado exclusivamente na estratégia BlueGreen
#
# Comunicação:
#   - Argo Rollouts controller atualiza automaticamente o selector deste service
#   - Aponta para pods da versão "preview/green" (nova versão não promovida)
#   - Acesso via port-forward ou Ingress separado para testes
#   - NÃO recebe tráfego de produção até promoção manual
#
# Fluxo BlueGreen:
#   1. Nova versão (Green) é deployada
#   2. Este service aponta para pods Green
#   3. Equipe testa via preview service
#   4. Após aprovação: promoção manual (kubectl argo rollouts promote)
#   5. Service active muda para Green, este service é desativado
#
# Uso em ambientes:
#   - DEV: Habilitado (estratégia blueGreen)
#   - PROD: Não usado (PROD usa estratégia canary)
# ============================================================================

{{- if and .Values.frontend.enabled .Values.frontend.rollout.enabled }}
{{- if eq .Values.frontend.rollout.strategy "blueGreen" }}
apiVersion: v1
kind: Service
metadata:
  name: {{ include "linktree.frontend.fullname" . }}-preview
  labels:
    {{- include "linktree.frontend.labels" . | nindent 4 }}
    service-type: preview
  annotations:
    # Identifica este service como preview para Argo Rollouts
    rollout.argoproj.io/service-type: preview
    argocd.argoproj.io/sync-wave: "1"
    {{- with .Values.frontend.service.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  type: {{ .Values.frontend.service.type }}
  ports:
    - port: {{ .Values.frontend.service.port }}
      targetPort: http
      protocol: TCP
      name: http
  # IMPORTANTE: Selector gerenciado automaticamente pelo Argo Rollouts controller
  # NÃO adicionar selector manualmente - controller injeta hash do ReplicaSet preview
{{- end }}
{{- end }}
