# ============================================================================
# BACKEND SERVICE CANARY - SERVIÇO PARA TRÁFEGO CANARY (PROD)
# ============================================================================
# Responsabilidade:
#   - Recebe porcentagem variável de tráfego durante rollout Canary
#   - Aponta para pods da nova versão (canary ReplicaSet)
#   - Usado exclusivamente na estratégia Canary em produção
#
# Comunicação:
#   - Argo Rollouts controller gerencia automaticamente o selector
#   - NGINX Ingress Controller divide tráfego entre stable e canary services
#   - Peso do tráfego controlado via annotations no Ingress (canary-weight)
#
# Fluxo Canary:
#   1. Nova versão deployada (canary ReplicaSet criado)
#   2. Este service aponta para pods canary
#   3. Ingress roteia X% tráfego para canary service, (100-X)% para stable
#   4. Steps progressivos: 10% → 25% → 50% → 75% → 100%
#   5. Após 100%, canary se torna stable (serviços trocam de função)
#
# Controle de tráfego:
#   - NGINX Ingress annotation: nginx.ingress.kubernetes.io/canary-weight
#   - Argo Rollouts atualiza automaticamente esta annotation
#   - Permite ajuste fino de tráfego (diferente de pod-based splitting)
#
# Uso em ambientes:
#   - DEV: Não usado (DEV usa BlueGreen)
#   - PROD: Habilitado (estratégia canary)
# ============================================================================

{{- if and .Values.backend.enabled .Values.backend.rollout.enabled }}
{{- if eq .Values.backend.rollout.strategy "canary" }}
apiVersion: v1
kind: Service
metadata:
  name: {{ include "linktree.backend.fullname" . }}-canary
  labels:
    {{- include "linktree.backend.labels" . | nindent 4 }}
    service-type: canary
  annotations:
    # Identifica este service como canary para Argo Rollouts
    rollout.argoproj.io/service-type: canary
    argocd.argoproj.io/sync-wave: "1"
    {{- with .Values.backend.service.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  type: {{ .Values.backend.service.type }}
  ports:
    - port: {{ .Values.backend.service.port }}
      targetPort: http
      protocol: TCP
      name: http
  # IMPORTANTE: Selector gerenciado automaticamente pelo Argo Rollouts controller
  # Controller injeta hash do ReplicaSet canary para rotear tráfego corretamente
{{- end }}
{{- end }}
