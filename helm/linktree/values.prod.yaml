# Production environment values for linktree

environment: production

backend:
  enabled: true
  replicaCount: 2

  image:
    repository: linktree-backend
    pullPolicy: Never
    tag: "v2.0.0"

  service:
    type: ClusterIP
    port: 8000
    annotations:
      prometsheus.io/scrape: "true"
      prometheus.io/port: "8000"
      prometheus.io/path: "/metrics"

  config:
    nodeEnv: production
    corsOrigin: "https://linktree.yourdomain.com"
    port: 8000

  # Secret único contendo todas as credenciais
  secretName: "linktree-secrets"

  database:
    host: "linktree-prod-postgresql-rw"
    port: "5432"
    database: "linktree_db"

  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 50m
      memory: 64Mi

  autoscaling:
    enabled: false
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80

  podDisruptionBudget:
    enabled: true
    minAvailable: 2

  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                    - linktree-backend
            topologyKey: kubernetes.io/hostname

  # ============================================================================
  # ARGO ROLLOUTS - CANARY DEPLOYMENT (PROD)
  # ============================================================================
  # Configuração para estratégia Canary em ambiente de produção
  # - Rollout gradual com aumento progressivo de tráfego
  # - Steps: 10% → 25% → 50% → 75% → 100%
  # - Pausas configuráveis em cada step para validação
  # - Integração com NGINX Ingress para controle fino de tráfego
  # - HPA compatível (escala proporcionalmente stable e canary)
  #
  # Comandos úteis:
  #   Ver status: kubectl argo rollouts get rollout linktree-prod-backend -n prod
  #   Ver peso: kubectl describe ing linktree-prod-backend-ingress -n prod | grep canary
  #   Promover: kubectl argo rollouts promote linktree-prod-backend -n prod
  #   Promover full: kubectl argo rollouts promote linktree-prod-backend -n prod --full
  #   Abortar: kubectl argo rollouts abort linktree-prod-backend -n prod
  #   Dashboard: kubectl argo rollouts dashboard
  # ============================================================================
  rollout:
    enabled: true
    strategy: canary

    canary:
      # Configuração dos steps de tráfego
      steps:
        step1:
          pauseDuration: 2m  # Pausa 2min em 10% de tráfego
        step2:
          pauseDuration: 5m  # Pausa 5min em 25% de tráfego
        step3:
          pauseDuration: 5m  # Pausa 5min em 50% de tráfego
        step4:
          pauseDuration: 5m  # Pausa 5min em 75% de tráfego
        # step5 (100%) não tem pausa, finaliza rollout

      # Controle de capacidade durante rollout
      maxSurge: "25%"      # Permite 25% mais pods durante rollout
      maxUnavailable: 0    # Mantém disponibilidade total

      # Análise automatizada (opcional - inicialmente desabilitado)
      analysis:
        enabled: false
        successRate:
          threshold: 95           # 95% de requisições bem-sucedidas
          errorRateMax: 5         # Máximo 5% de erro
          latencyP95Max: 500      # P95 latência máxima 500ms

  # Ingress configuration for external access and canary traffic control
  ingress:
    enabled: true
    host: api.linktree.yourdomain.com
    annotations: {}
    tls:
      enabled: true
      clusterIssuer: letsencrypt-prod

frontend:
  enabled: true
  replicaCount: 3

  image:
    repository: linktree-frontend
    pullPolicy: Never
    tag: ""
    pullSecrets:
      - name: ghcr-secret

  service:
    type: ClusterIP
    port: 80

  config:
    apiUrl: "https://api.linktree.yourdomain.com"

  resources:
    limits:
      cpu: 300m
      memory: 384Mi
    requests:
      cpu: 150m
      memory: 192Mi

  autoscaling:
    enabled: false  # Temporarily disabled to allow Rollout creation
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80

  podDisruptionBudget:
    enabled: true
    minAvailable: 2

  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                    - linktree-frontend
            topologyKey: kubernetes.io/hostname

  # ============================================================================
  # ARGO ROLLOUTS - CANARY DEPLOYMENT (PROD) - FRONTEND
  # ============================================================================
  # Mesma configuração Canary do backend aplicada ao frontend
  # Frontend e backend são deployados independentemente
  # ============================================================================
  rollout:
    enabled: true
    strategy: canary

    canary:
      steps:
        step1:
          pauseDuration: 2m
        step2:
          pauseDuration: 5m
        step3:
          pauseDuration: 5m
        step4:
          pauseDuration: 5m

      maxSurge: "25%"
      maxUnavailable: 0

      analysis:
        enabled: false

  # Ingress configuration for frontend
  ingress:
    enabled: true
    host: linktree.yourdomain.com
    annotations: {}
    tls:
      enabled: true
      clusterIssuer: letsencrypt-prod
